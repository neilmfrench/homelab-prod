---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: commute-dashboard
spec:
  values:
    controllers:
      commute-dashboard:
        containers:
          app:
            image:
              repository: nginx
              tag: alpine
            resources:
              requests:
                cpu: 10m
                memory: 32Mi
              limits:
                memory: 64Mi
    configMaps:
      dashboard:
        enabled: true
        data:
          index.html: |
            <!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Commute Dashboard</title>
              <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }

                body {
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                  background: rgb(16, 18, 21);
                  color: rgb(228, 228, 231);
                  height: 100vh;
                  overflow: hidden;
                }

                #map {
                  width: 100%;
                  height: 100vh;
                }

                .info-panel {
                  position: absolute;
                  bottom: 40px;
                  right: 40px;
                  background: rgb(35, 36, 43);
                  border-radius: 20px;
                  padding: 28px 36px;
                  box-shadow: 0 3px 8px 0 rgba(0, 0, 0, 0.12);
                  min-width: 320px;
                }

                .drive-time {
                  font-size: 48px;
                  font-weight: 600;
                  color: rgb(228, 228, 231);
                  display: flex;
                  align-items: center;
                  gap: 12px;
                }

                .drive-time .dot {
                  width: 16px;
                  height: 16px;
                  border-radius: 50%;
                  background: rgb(118, 214, 152);
                }

                .drive-time.slow .dot { background: rgb(255, 219, 117); }
                .drive-time.heavy .dot { background: rgb(234, 114, 135); }

                .destination {
                  font-size: 20px;
                  color: rgb(138, 140, 153);
                  margin-top: 8px;
                }

                .route-info {
                  font-size: 16px;
                  color: rgb(138, 140, 153);
                  margin-top: 16px;
                  padding-top: 16px;
                  border-top: 1px solid rgb(46, 48, 56);
                }

                .updated {
                  font-size: 14px;
                  color: rgb(138, 140, 153);
                  margin-top: 12px;
                }

                .no-commute {
                  text-align: center;
                  padding: 20px 0;
                }

                .no-commute .icon {
                  font-size: 48px;
                  margin-bottom: 12px;
                }

                .no-commute .message {
                  font-size: 24px;
                  color: rgb(138, 140, 153);
                }
              </style>
            </head>
            <body>
              <div id="map"></div>
              <div class="info-panel" id="info-panel">
                <div class="no-commute" id="no-commute" style="display: none;">
                  <div class="icon">üè†</div>
                  <div class="message">No commute scheduled</div>
                </div>
                <div id="commute-info">
                  <div class="drive-time" id="drive-time">
                    <span class="dot"></span>
                    <span id="duration">--</span>
                  </div>
                  <div class="destination" id="destination">to Office</div>
                  <div class="route-info" id="route-info">-- via --</div>
                  <div class="updated" id="updated">Updated --:--</div>
                </div>
              </div>

              <script>
                const CONFIG = {
                  home: { lat: parseFloat('${SECRET_HOME_LAT}'), lng: parseFloat('${SECRET_HOME_LNG}') },
                  office: { lat: parseFloat('${SECRET_OFFICE_LAT}'), lng: parseFloat('${SECRET_OFFICE_LNG}') },
                  morningStart: 10,
                  morningEnd: 12,
                  eveningStart: 19,
                  eveningEnd: 21,
                  refreshInterval: 5 * 60 * 1000
                };

                let map, directionsService, directionsRenderer;

                function initMap() {
                  const mapStyles = [
                    { elementType: "geometry", stylers: [{ color: "#1d2c4d" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#8ec3b9" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#1a3646" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#304a7d" }] },
                    { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#255763" }] },
                    { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#2c6675" }] },
                    { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#255763" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#0e1626" }] },
                    { featureType: "poi", stylers: [{ visibility: "off" }] },
                    { featureType: "transit", stylers: [{ visibility: "off" }] }
                  ];

                  map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 12,
                    center: CONFIG.home,
                    styles: mapStyles,
                    disableDefaultUI: true,
                    zoomControl: false,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false
                  });

                  const trafficLayer = new google.maps.TrafficLayer();
                  trafficLayer.setMap(map);

                  directionsService = new google.maps.DirectionsService();
                  directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: false,
                    polylineOptions: {
                      strokeColor: 'rgb(224, 138, 0)',
                      strokeWeight: 5
                    }
                  });

                  updateRoute();
                  setInterval(updateRoute, CONFIG.refreshInterval);
                }

                function isCommuteWindow() {
                  const hour = new Date().getHours();
                  const day = new Date().getDay();
                  if (day === 0 || day === 6) return null;
                  if (hour >= CONFIG.morningStart && hour < CONFIG.morningEnd) return 'morning';
                  if (hour >= CONFIG.eveningStart && hour < CONFIG.eveningEnd) return 'evening';
                  return null;
                }

                function updateRoute() {
                  const commutePeriod = isCommuteWindow();

                  if (!commutePeriod) {
                    document.getElementById('no-commute').style.display = 'block';
                    document.getElementById('commute-info').style.display = 'none';
                    directionsRenderer.setDirections({ routes: [] });
                    return;
                  }

                  document.getElementById('no-commute').style.display = 'none';
                  document.getElementById('commute-info').style.display = 'block';

                  const origin = commutePeriod === 'morning' ? CONFIG.home : CONFIG.office;
                  const destination = commutePeriod === 'morning' ? CONFIG.office : CONFIG.home;
                  const destLabel = commutePeriod === 'morning' ? 'to Office' : 'to Home';

                  document.getElementById('destination').textContent = destLabel;

                  directionsService.route({
                    origin: origin,
                    destination: destination,
                    travelMode: google.maps.TravelMode.DRIVING,
                    drivingOptions: {
                      departureTime: new Date(),
                      trafficModel: google.maps.TrafficModel.BEST_GUESS
                    }
                  }, (response, status) => {
                    if (status === 'OK') {
                      directionsRenderer.setDirections(response);

                      const route = response.routes[0].legs[0];
                      const durationInTraffic = route.duration_in_traffic || route.duration;
                      const normalDuration = route.duration;

                      document.getElementById('duration').textContent = durationInTraffic.text;
                      document.getElementById('route-info').textContent =
                        route.distance.text + ' via ' + route.summary;

                      const driveTimeEl = document.getElementById('drive-time');
                      driveTimeEl.classList.remove('slow', 'heavy');

                      const ratio = durationInTraffic.value / normalDuration.value;
                      if (ratio > 1.5) {
                        driveTimeEl.classList.add('heavy');
                      } else if (ratio > 1.2) {
                        driveTimeEl.classList.add('slow');
                      }

                      const now = new Date();
                      document.getElementById('updated').textContent =
                        'Updated ' + now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    }
                  });
                }
              </script>
              <script async defer
                src="https://maps.googleapis.com/maps/api/js?key=${SECRET_GOOGLE_MAPS_API_KEY}&callback=initMap">
              </script>
            </body>
            </html>
    persistence:
      dashboard:
        enabled: true
        type: configMap
        name: commute-dashboard
        globalMounts:
          - path: /usr/share/nginx/html
    service:
      app:
        controller: commute-dashboard
        ports:
          http:
            port: 80
    ingress:
      app:
        enabled: true
        className: traefik
        hosts:
          - host: &host "commute.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: app
                  port: http
