---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: home-assistant
spec:
  values:
    defaultPodOptions:
      # hostNetwork: true
      # dnsPolicy: ClusterFirstWithHostNet
      # nodeSelector:
      #   kubernetes.io/hostname: "talos-4"
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
    controllers:
      main:
        initContainers:
          init-config:
            image:
              repository: busybox
              tag: latest
            securityContext:
              runAsUser: 0
              runAsGroup: 0
            command:
              - /bin/sh
              - -c
            args:
              - |
                if [ ! -f /config/configuration.yaml ]; then
                  echo "Initializing Home Assistant config..."
                  cp /config-init/configuration.yaml /config/
                  echo "[]" > /config/automations.yaml
                  touch /config/scripts.yaml
                  echo "[]" > /config/scenes.yaml
                  mkdir -p /config/themes
                  echo "Config initialized."
                else
                  echo "Config already exists, skipping init."
                fi
        containers:
          main:
            image:
              repository: homeassistant/home-assistant
              tag: "2026.1.3"
            env:
              TZ: "${TIMEZONE}"
            securityContext:
              privileged: true
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 8123
                  initialDelaySeconds: 30
                  periodSeconds: 20
                  timeoutSeconds: 2
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 8123
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              startup:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 8123
                  initialDelaySeconds: 5
                  periodSeconds: 5
                  timeoutSeconds: 1
                  failureThreshold: 30
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 4000Mi
          codeserver:
            image:
              repository: docker.io/codercom/code-server
              tag: 4.108.2
            env:
              TZ: "${TIMEZONE}"
            workingDir: /config
            securityContext:
              runAsUser: 0
              runAsGroup: 0
            args:
              - --auth
              - "none"
              - --user-data-dir
              - "/config/.vscode"
              - --extensions-dir
              - "/config/.vscode"
            probes:
              liveness:
                enabled: false
              readiness:
                enabled: false
              startup:
                enabled: false
    configMaps:
      config-init:
        enabled: true
        data:
          configuration.yaml: |
            # Home Assistant Configuration
            default_config:

            # HTTP configuration for reverse proxy
            http:
              use_x_forwarded_for: true
              trusted_proxies:
                - 10.0.0.0/8
                - 172.16.0.0/12
                - 192.168.0.0/16
                - 127.0.0.1
                - ::1

            # Load frontend themes from the themes folder
            frontend:
              themes: !include_dir_merge_named themes

            # Text to speech
            tts:
              - platform: google_translate

            # Automations, scripts, scenes
            automation: !include automations.yaml
            script: !include scripts.yaml
            scene: !include scenes.yaml
    service:
      main:
        controller: main
        ports:
          http:
            port: 8123
      codeserver:
        controller: main
        ports:
          http:
            port: 8080
    ingress:
      main:
        enabled: true
        className: "traefik"
        hosts:
          - host: &host "home.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: main
                  port: http
      codeserver:
        enabled: true
        className: "traefik"
        hosts:
          - host: &host-config "hass-config.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: codeserver
                  port: http
      oidc-login:
        enabled: true
        className: "traefik"
        annotations:
          traefik.ingress.kubernetes.io/router.middlewares: "home-home-assistant-oidc-redirect@kubernetescrd"
        hosts:
          - host: "home-login.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: main
                  port: http
    persistence:
      config:
        enabled: true
        existingClaim: home-assistant-config
        globalMounts:
          - path: /config
      config-init:
        enabled: true
        type: configMap
        name: home-assistant
        advancedMounts:
          main:
            init-config:
              - path: /config-init
