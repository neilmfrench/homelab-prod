---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: home-assistant
spec:
  values:
    defaultPodOptions:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
        kubernetes.io/hostname: "talos-4"
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
    controllers:
      main:
        containers:
          main:
            image:
              repository: homeassistant/home-assistant
              tag: "2026.1.3"
            env:
              TZ: "${TIMEZONE}"
            securityContext:
              privileged: true
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 8123
                  initialDelaySeconds: 30
                  periodSeconds: 20
                  timeoutSeconds: 2
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 8123
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              startup:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 8123
                  initialDelaySeconds: 5
                  periodSeconds: 5
                  timeoutSeconds: 1
                  failureThreshold: 30 
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 4000Mi
          codeserver:
            image:
              repository: docker.io/codercom/code-server
              tag: 4.108.2
            env:
              TZ: "${TIMEZONE}"
            securityContext:
              runAsUser: 0
              runAsGroup: 0
            args:
              - --auth
              - "none"
              - --user-data-dir
              - "/config/.vscode"
              - --extensions-dir
              - "/config/.vscode"
            probes:
              liveness:
                enabled: false
              readiness:
                enabled: false
              startup:
                enabled: false
    service:
      main:
        controller: main
        ports:
          http:
            port: 8123
      codeserver:
        controller: main
        ports:
          http:
            port: 8080
    ingress:
      main:
        enabled: true
        className: "traefik"
        hosts:
          - host: &host "home.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: main
                  port: http
      codeserver:
        enabled: true
        className: "traefik"
        hosts:
          - host: &host-config "hass-config.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: codeserver
                  port: http
    persistence:
      config:
        enabled: true
        existingClaim: home-assistant-config
        globalMounts:
          - path: /config
