---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: crowdsec-traefik-bouncer
spec:
  interval: 15m
  chart:
    spec:
      chart: crowdsec-traefik-bouncer
      version: 0.1.2
      sourceRef:
        kind: HelmRepository
        name: crowdsec
        namespace: flux-system
  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  postRenderers:
    - kustomize:
        # https://github.com/fbonalair/traefik-crowdsec-bouncer/blob/cc1abf6238d9dee47e6cd7866e1d51ab9d053dc1/controler/controler.go
        patchesJson6902:
          - target:
              kind: Deployment
              name: crowdsec-traefik-bouncer
            patch:
              - op: add
                path: /spec/template/spec/containers/0/env/-
                value:
                  name: CROWDSEC_BOUNCER_SCHEME
                  value: "https"
