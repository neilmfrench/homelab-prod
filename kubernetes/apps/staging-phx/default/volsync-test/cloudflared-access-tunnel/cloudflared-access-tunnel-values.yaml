---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cloudflared-access-tunnel
spec:
  values:
    # controller:
    #   annotations:
    #     configmap.reloader.stakater.com/reload: "cloudflared-configmap"
    image:
      repository: cloudflare/cloudflared
      tag: "2023.3.1"
    args:
      - access
      - tcp
      - --hostname
      - vs-test-home.${SECRET_DOMAIN}
      - --url
      - 127.0.0.1:9210
    service:
      main:
        ports:
          http:
            enabled: false
            primary: false
          tcp:
            port: 9210
            protocol: TCP
            primary: true
    probes:
      liveness:
        enabled: false
      readiness:
        enabled: false
      startup:
        enabled: false
    persistence:
      tunnel-credentials:
        enabled: true
        type: secret
        name: volsync-test-cloudflared-tunnel-credentials
        mountPath: /etc/cloudflared/creds
        readOnly: true
